<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Space Invaders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body { margin:0; padding:0; overflow:hidden; background:#000; }
    canvas { display:block; width:100vw; height:100vh; }
    #controls { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:10px; }
    .btn { width:60px; height:60px; background:rgba(255,255,255,0.2); color:#fff; font-size:24px; border:none; border-radius:30px; }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div id="controls">
  <button id="left" class="btn">◀︎</button>
  <button id="shoot" class="btn">●</button>
  <button id="right" class="btn">▶︎</button>
</div>
<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let width, height;
  function resize(){
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  }
  window.addEventListener('resize', resize);
  resize();

  // load images
  const playerImg = new Image();
  playerImg.src = '../images/AO.png';
  const invaderImg = new Image();
  invaderImg.src = '../images/kaiju.png';

  // Game variables
  let player = { x: width/2, y: height-60, w: 50, h: 50, speed: 5 };
  let bullets = [];
  let invaders = [];
  const invaderRows = 4, invaderCols = 8;
  const invaderW = 40, invaderH = 40, invaderPadding = 20;
  const invaderOffsetTop = 60, invaderOffsetLeft = 60;
  let invaderDir = 1;
  let score = 0;
  let gameOver = false;

  // create invaders
  for(let r=0; r<invaderRows; r++){
    for(let c=0; c<invaderCols; c++){
      invaders.push({
        x: invaderOffsetLeft + c*(invaderW+invaderPadding),
        y: invaderOffsetTop + r*(invaderH+invaderPadding),
        w: invaderW, h: invaderH, alive: true
      });
    }
  }

  // controls
  const keys = {};
  document.addEventListener('keydown', e => keys[e.code] = true);
  document.addEventListener('keyup', e => keys[e.code] = false);
  document.getElementById('left').addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowLeft'] = true; });
  document.getElementById('left').addEventListener('touchend', e => { e.preventDefault(); keys['ArrowLeft'] = false; });
  document.getElementById('right').addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowRight'] = true; });
  document.getElementById('right').addEventListener('touchend', e => { e.preventDefault(); keys['ArrowRight'] = false; });
  document.getElementById('shoot').addEventListener('touchstart', e => { e.preventDefault(); shoot(); });
  document.addEventListener('keydown', e => { if(e.code === 'Space') shoot(); });

  function shoot(){
    bullets.push({ x: player.x, y: player.y - player.h/2, r: 5, speed: 7 });
  }

  function update(){
    if(gameOver) return;
    // player move
    if(keys['ArrowLeft']) player.x -= player.speed;
    if(keys['ArrowRight']) player.x += player.speed;
    player.x = Math.max(player.w/2, Math.min(width - player.w/2, player.x));

    // bullets
    bullets = bullets.filter(b => b.y > 0);
    bullets.forEach(b => b.y -= b.speed);

    // invaders movement
    let shiftDown = false;
    const aliveInv = invaders.filter(i => i.alive);
    const rightMost = Math.max(...aliveInv.map(i => i.x + i.w/2));
    const leftMost = Math.min(...aliveInv.map(i => i.x - i.w/2));
    if(rightMost + 10 >= width) { invaderDir = -1; shiftDown = true; }
    if(leftMost - 10 <= 0) { invaderDir = 1; shiftDown = true; }
    invaders.forEach(i => {
      i.x += invaderDir;
      if(shiftDown) i.y += 10;
      if(i.alive && i.y + i.h/2 >= player.y - player.h/2) gameOver = true;
    });

    // collisions
    bullets.forEach(b => {
      invaders.forEach(i => {
        if(i.alive && b.x > i.x - i.w/2 && b.x < i.x + i.w/2 && b.y > i.y - i.h/2 && b.y < i.y + i.h/2){
          i.alive = false;
          b.y = -10;
          score += 10;
        }
      });
    });

    // win?
    if(invaders.every(i => !i.alive)) gameOver = true;
  }

  function draw(){
    ctx.clearRect(0, 0, width, height);
    // draw player
    if(playerImg.complete) {
      ctx.drawImage(playerImg, player.x - player.w/2, player.y - player.h/2, player.w, player.h);
    }

    // draw bullets
    ctx.fillStyle = '#ff0';
    bullets.forEach(b => {
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
      ctx.fill();
    });

    // draw invaders
    invaders.forEach(i => {
      if(i.alive && invaderImg.complete) {
        ctx.drawImage(invaderImg, i.x - i.w/2, i.y - i.h/2, i.w, i.h);
      }
    });

    // draw score
    ctx.fillStyle = '#fff';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Score: ' + score, 10, 30);

    if(gameOver){
      ctx.fillStyle = '#fff';
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Game Over', width/2, height/2);
      ctx.font = '20px Arial';
      ctx.fillText('Tap to Restart', width/2, height/2 + 40);
    }
  }

  function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
  }

  canvas.addEventListener('click', () => { if(gameOver) location.reload(); });
  canvas.addEventListener('touchstart', () => { if(gameOver) location.reload(); });

  loop();
})();
</script>
</body>
</html>
